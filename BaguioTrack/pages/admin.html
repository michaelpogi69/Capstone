<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baguio Track | Admin Dashboard</title>
  <link rel="stylesheet" href="../assets/css/admin.css" />
</head>
<body>
  <main class="admin-shell">
    <header class="admin-header">
      <div>
        <h1>Admin Dashboard</h1>
        <p id="adminWelcome">Managing Baguio Track</p>
      </div>
      <button class="logout-btn" id="adminLogoutBtn">Logout</button>
    </header>

    <section class="stats-grid">
      <article class="stat-card">
        <h3>Registered Users</h3>
        <p class="value">1,248</p>
      </article>
      <article class="stat-card">
        <h3>Daily Visitors</h3>
        <p class="value">532</p>
      </article>
      <article class="stat-card">
        <h3>Tourist Spot Pages</h3>
        <p class="value">9</p>
      </article>
      <article class="stat-card">
        <h3>Safety Posts</h3>
        <p class="value">14</p>
      </article>
    </section>

    <section class="panel-grid">
      <article class="panel">
        <h2>Quick Actions</h2>
        <div class="quick-actions">
          <button class="action-btn" data-page="tourist.html">Edit Tourist Spots</button>
          <button class="action-btn" data-page="jeepterminal.html">Update Terminals</button>
          <button class="action-btn" data-page="safety.html">Publish Safety Tip</button>
          <button class="action-btn" data-page="about.html">Edit About Page</button>
        </div>
      </article>

      <article class="panel">
        <h2>Recent Activity</h2>
        <ul class="activity-list">
          <li>
            Updated terminal fare guide.
            <span class="activity-time">Today, 9:40 AM</span>
          </li>
          <li>
            Added new image to Mines View page.
            <span class="activity-time">Yesterday, 4:20 PM</span>
          </li>
          <li>
            Safety hotline list was reviewed.
            <span class="activity-time">Yesterday, 11:10 AM</span>
          </li>
        </ul>
      </article>
    </section>

    <section class="panel announcement-box" style="margin-top: 16px;">
      <h2>Site Announcement</h2>
      <textarea id="announcementInput" placeholder="Write an announcement for all users..."></textarea>
      <button id="saveAnnouncementBtn">Save Announcement</button>
      <p id="saveStatus" class="saved-note"></p>
    </section>

    <!-- ✅ NEW: USER FEEDBACK PANEL -->
    <section class="panel" style="margin-top: 16px;">
      <h2>User Feedback</h2>

      <div id="feedbackStatus" class="saved-note" style="margin-bottom: 10px;"></div>

      <!-- Container where feedback appears -->
      <div id="feedbackList" style="display: grid; gap: 12px;"></div>

      <!-- Template styles (works even if your admin.css doesn't have these) -->
      <style>
        .fb-card{
          background: #fff;
          border-radius: 12px;
          padding: 14px 14px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        }
        .fb-meta{
          font-size: 13px;
          opacity: 0.85;
          margin-bottom: 8px;
          line-height: 1.35;
        }
        .fb-msg{
          font-size: 14px;
          line-height: 1.5;
          white-space: pre-wrap;
        }
        .fb-empty{
          background: #fff;
          border-radius: 12px;
          padding: 14px;
          box-shadow: 0 3px 10px rgba(0,0,0,0.06);
        }
      </style>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPFnyJC66A-HQC3dKCQQ4SobAFRezx7fU",
      authDomain: "baguio-track-c702f.firebaseapp.com",
      projectId: "baguio-track-c702f",
      storageBucket: "baguio-track-c702f.firebasestorage.app",
      messagingSenderId: "27598181344",
      appId: "1:27598181344:web:97bf7dd2a32dbfe14ed185"
    };

    const ADMIN_ALLOWLIST = [
      "michaelreynotarte69@gmail.com",
      "jammytanglib45@gmail.com",
      "psychandreilopez18@gmail.com"
    ];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminWelcome = document.getElementById("adminWelcome");

    const forceLogout = async () => {
      localStorage.removeItem("isAdminLoggedIn");
      localStorage.removeItem("adminEmail");
      try {
        await signOut(auth);
      } catch (error) {
        console.log("Sign-out skipped:", error.message);
      }
      window.location.href = "adminlogin.html";
    };

    onAuthStateChanged(auth, (user) => {
      const signedInEmail = user?.email?.toLowerCase() || "";
      const isAllowedAdmin = ADMIN_ALLOWLIST.includes(signedInEmail);

      if (!user || !isAllowedAdmin) {
        forceLogout();
        return;
      }

      localStorage.setItem("isAdminLoggedIn", "true");
      localStorage.setItem("adminEmail", signedInEmail);
      adminWelcome.textContent = `Logged in as ${signedInEmail}`;

      // ✅ Start listening to feedback ONLY when admin is verified
      startFeedbackListener();
    });

    document.getElementById("adminLogoutBtn").addEventListener("click", () => {
      forceLogout();
    });

    document.querySelectorAll(".action-btn").forEach((button) => {
      button.addEventListener("click", () => {
        const targetPage = button.getAttribute("data-page");
        window.location.href = targetPage;
      });
    });

    // Announcement (your current code)
    const announcementInput = document.getElementById("announcementInput");
    const saveStatus = document.getElementById("saveStatus");

    announcementInput.value = localStorage.getItem("siteAnnouncement") || "";

    document.getElementById("saveAnnouncementBtn").addEventListener("click", () => {
      localStorage.setItem("siteAnnouncement", announcementInput.value.trim());
      saveStatus.textContent = "Announcement saved successfully.";
      setTimeout(() => {
        saveStatus.textContent = "";
      }, 3000);
    });

    // ✅ Feedback viewer (Firestore -> Admin page)
    const feedbackList = document.getElementById("feedbackList");
    const feedbackStatus = document.getElementById("feedbackStatus");

    function formatDate(ts) {
      try {
        if (!ts) return "Just now";
        return ts.toDate().toLocaleString();
      } catch {
        return "Unknown date";
      }
    }

    function renderEmpty() {
      feedbackList.innerHTML = "";
      const empty = document.createElement("div");
      empty.className = "fb-empty";
      empty.textContent = "No feedback yet.";
      feedbackList.appendChild(empty);
    }

    function addFeedbackCard(data) {
  const card = document.createElement("div");
  card.className = "fb-card";

  const msg = document.createElement("div");
  msg.className = "fb-msg";
  msg.textContent = (data.message || "").toString();

  card.appendChild(msg);
  feedbackList.appendChild(card);
}


    function startFeedbackListener() {
      feedbackStatus.textContent = "Loading feedback...";

      const fbQuery = query(
        collection(db, "feedback"),
        orderBy("createdAt", "desc")
      );

      onSnapshot(
        fbQuery,
        (snapshot) => {
          feedbackList.innerHTML = "";

          if (snapshot.empty) {
            feedbackStatus.textContent = "";
            renderEmpty();
            return;
          }

          feedbackStatus.textContent = `Showing ${snapshot.size} feedback message(s).`;

          snapshot.forEach((docSnap) => {
            addFeedbackCard(docSnap.data());
          });
        },
        (error) => {
          console.error(error);
          feedbackStatus.textContent = "❌ Failed to load feedback. Check Firestore rules / console.";
          renderEmpty();
        }
      );
    }
  </script>
</body>
</html>
